---
layout: post
title: Github Login APIë¡œ ì‚¬ìš©ì ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
image: 4.jpg
tags: [iOS, Swift, Github, Login, API]
categories: iOS
---
ê°œì¸ í† ì´ í”„ë¡œì íŠ¸ì— ê¹ƒí—ˆë¸Œ ë¡œê·¸ì¸ì„ ì‚¬ìš©í•  ì¼ì´ ìƒê²¨, ì²˜ìŒìœ¼ë¡œ(!) Login API ì‚¬ìš©ì— ë„ì „í•´ ë³´ì•˜ë‹¤. ë„¤ì•„ë¡œë‚˜ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì„ ë¨¼ì € ì“°ê²Œ ë  ì¤„ ì•Œì•˜ëŠ”ë° ì‚¬ëŒ ì¼ì€ ëª¨ë¥´ëŠ” ì¼ì´ë‹¤. <br>
ê°ì„¤í•˜ê³ , ë°”ë¡œ ì‹œì‘í•´ë³´ì.
<br>

ì „ì²´ì ì¸ ë°©ë²•ì€ ê¹ƒí—ˆë¸Œì—ì„œ ê³µì‹ì ìœ¼ë¡œ ì œê³µí•˜ëŠ” [ë¬¸ì„œ](https://docs.github.com/en/enterprise-server@2.21/developers/apps/authorizing-oauth-apps)ë¥¼ ê·¸ëŒ€ë¡œ ë”°ë¼ê°€ë©´ ë˜ì§€ë§Œ ì²˜ìŒì´ë¼ ê·¸ëŸ°ì§€ ì–´ë ¤ì›€ì´ ì¢€ ìˆì—ˆë‹¤. ë‹¤ë¥¸ SNS ë¡œê·¸ì¸ APIë„ í¬ê²Œ ë‹¤ë¥´ì§€ ì•Šì„ ê²ƒì´ë¼ ìƒê°í•˜ê¸°ì— ì´ ê³³ì— ì „ì²´ ê³¼ì •ì„ ê¸°ë¡í•´ë‘ë ¤ í•œë‹¤.
<br>
<br>

## 1. ê¹ƒí—ˆë¸Œì— ì• í”Œë¦¬ì¼€ì´ì…˜ ë“±ë¡í•˜ê¸°
---

ìš°ì„  ë‚´ê°€ ì‚¬ìš©í•  ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ê¹ƒí—ˆë¸Œì— ë“±ë¡í–ˆë‹¤. [Settings] - [Developer settings] - [OAuth Apps]ì—ì„œ [New OAuth App]ì„ í´ë¦­í•˜ì—¬ ìƒˆë¡œìš´ ì•±ì„ ìƒì„±í•´ì£¼ì—ˆë‹¤.
<br>
<img src = "{{site.baseurl}}/images/20201110_4/github_login_register.png" width="45%">
<img src = "{{site.baseurl}}/images/20201110_4/github_login_register_2.png" width="45%">
<br>
<br>
Application nameì—ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¦„ì„, Homepage URLì€ ê¹ƒí—™ ì €ì¥ì†Œ ì£¼ì†Œë¥¼ ë„£ì–´ì£¼ì—ˆë‹¤. <br>
Authorization callback URLì˜ ê²½ìš°, <br>
ì• í”Œë¦¬ì¼€ì´ì…˜ í”„ë¡œì íŠ¸ì˜ [TARGETS] - [Info]ì˜ [URL Types]ë¥¼ ì¶”ê°€í•´ ì•„ë˜ ì‚¬ì§„ê³¼ ê°™ì´ ê°„ë‹¨íˆ callback urlì„ ìƒì„±í•  ìˆ˜ ìˆë‹¤.
<br>
<img src = "{{site.baseurl}}/images/20201110_4/github_login_callback_url.png" width="90%">
<br>
<br>
<br>

ì•±ì„ ë“±ë¡í•˜ê³  ë‚˜ë©´ ì•„ë˜ì˜ ì‚¬ì§„ê³¼ ê°™ì´ client IDì™€ client Secretì„ í™•ì¸í•  ìˆ˜ ìˆëŠ” í™”ë©´ì´ ë‚˜íƒ€ë‚œë‹¤. client Secretì€ ì²˜ìŒì—ëŠ” ìƒì„±ë˜ì–´ ìˆì§€ ì•Šìœ¼ë¯€ë¡œ [Generate a new client secret]ìœ¼ë¡œ ìƒˆë¡œìš´ í‚¤ê°’ì„ ìƒì„±ì‹œì¼œì£¼ë„ë¡ í•œë‹¤.

<img src = "{{site.baseurl}}/images/20201110_4/registered_app_main.png" width="100%">
<br>
<br>
<br>
<br>
<br>

## 2. ì‚¬ìš©ì ê¶Œí•œ ìš”ì²­í•˜ê¸°
---

ëª¨ë“  ì¤€ë¹„ê°€ ëë‚¬ë‹¤ë©´, ì´í›„ë¡œëŠ” ì½”ë”©ì˜ ì˜ì—­ì´ë‹¤. ê°„ë‹¨íˆ ë¡œê·¸ì¸ì„ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ í™”ë©´ì— ë¡œê·¸ì¸ ë²„íŠ¼ê³¼ ë¡œê·¸ì¸ì´ ë˜ì—ˆëŠ”ì§€ í‘œì‹œí•´ì£¼ëŠ” ë ˆì´ë¸”ë§Œ ì•± í™”ë©´ì— ë°°ì¹˜í•˜ì˜€ë‹¤.

<div style="text-align: center;"><img src = "{{site.baseurl}}/images/20201110_4/simple_appmain.png" width="70%"></div>
<br>
<br>
<br>

ë¡œê·¸ì¸ ë²„íŠ¼ì„ í„°ì¹˜í–ˆì„ ë•Œ ì‚¬íŒŒë¦¬ (ì™¸ë¶€)ì•±ìœ¼ë¡œ ì´ë™í•´ ì‚¬ìš©ìì˜ ê¶Œí•œì„ ìš”ì²­í•´ì•¼ í•œë‹¤. ë”°ë¼ì„œ ë²„íŠ¼ì˜ IBAction ë©”ì„œë“œë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•˜ì˜€ë‹¤.

{% highlight Swift %}
@IBAction func loginGithub(_ sender: UIButton) {
    let clientID = ClientLogin.client_id
    let scope = ClientLogin.scope // repo user
    let urlString = ClientLogin.reqAuthUrl // https://github.com/login/oauth/authorize
    var components = URLComponents(string: urlString)!
    
    components.queryItems = [
        URLQueryItem(name: "client_id", value: clientID),
        URLQueryItem(name: "scope", value: scope)
    ]
    guard let url = components.url else { return }
    // UserInfoManager.delegate = self
    UIApplication.shared.open(url)
}
{% endhighlight %}

client_idì™€ client_secretì´ ë‹¤ë¥¸ ê³³ì—ì„œë„ ì‚¬ìš©ë˜ì—ˆê¸°ì— (ì˜ˆë¥¼ ë“¤ì–´ SceneDelegate...) ì•„ì˜ˆ ClientLogin structë¥¼ ìƒì„±í•˜ì—¬ ê·¸ê³³ì— static ìƒìˆ˜ ê°’ìœ¼ë¡œ ì •ì˜í•´ë‘ì—ˆë‹¤.<br>
scopeì˜ ê²½ìš° í”„ë¡œê·¸ë˜ë¨¸ê°€ í•„ìš”í•œ ì‚¬ìš©ì ê¶Œí•œ ë²”ìœ„ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê²ƒì¸ë° ë‚˜ì˜ ê²½ìš° repo, userë¡œ ì§€ì •í•˜ì˜€ë‹¤.

í•´ë‹¹ ë©”ì„œë“œë¥¼ ì‘ì„±í•˜ê³  ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì‚¬íŒŒë¦¬ ì•±ìœ¼ë¡œ ì˜ ë„˜ì–´ê°€ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.(ì£¼ì„ìœ¼ë¡œ ì²˜ë¦¬í•´ ë‘” ë¸ë¦¬ê²Œì´íŠ¸ ì²˜ë¦¬ëŠ” ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì´ì–´ì„œ ì„¤ëª…í•˜ê² ë‹¤.)

<div style="text-align: center;">
	<img src = "{{site.baseurl}}/images/20201110_4/test1.png" width="30%">
	<img src = "{{site.baseurl}}/images/20201110_4/test2.png" width="30%">
	<img src = "{{site.baseurl}}/images/20201110_4/test3.png" width="30%">
</div>

ì‚¬ìš©ìì˜ ê¶Œí•œì„ ì–»ì–´ ì™€ì„œ ë‹¤ì‹œ ì•±ì„ ì—´ë©´ ê¹ƒí—ˆë¸ŒëŠ” codeë¥¼ ë³´ë‚´ê²Œ ë˜ëŠ”ë°, ì´ëŠ” 10ë¶„ í›„ì— ë§Œë£Œë˜ë¯€ë¡œ ë°›ì•„ì˜¨ ì¦‰ì‹œ access tokenì„ ìš”ì²­í•˜ë„ë¡ ì²˜ë¦¬í•˜ì˜€ë‹¤. ì´ëŸ¬í•œ codeëŠ” SceneDelegate ë˜ëŠ” AppDelegateì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ì—¬ê¸°ì—ì„  SceneDelegateë¥¼ í†µí•´ ë°›ì•„ì˜¨ codeë¥¼ ì²˜ë¦¬í•˜ì˜€ë‹¤.

{% highlight Swift %}
func scene(_ scene: UIScene, openURLContexts URLContexts: Set<UIOpenURLContext>) {
    if let url = URLContexts.first?.url {
        let code = url.absoluteString.split(separator: "=").last?.description ?? ""

        if !code.isEmpty {
            var component = URLComponents(string: ClientLogin.tokenReqUrl)
            // tokenReqUrl: https://github.com/login/oauth/access_token
            let required = [
                URLQueryItem(name: "client_id", value: ClientLogin.client_id),
                URLQueryItem(name: "client_secret", value: ClientLogin.client_secret),
                URLQueryItem(name: "code", value: code)
            ]
            component?.queryItems = required
            
            guard let tokenUrl = component?.url else { return }
            var request = URLRequest(url: tokenUrl)
            request.setValue("application/json", forHTTPHeaderField: "Accept")
            
            let session = URLSession(configuration: .default)
            let dataTask = session.dataTask(with: request) { (data, response, error) in
                let successRange = 200 ..< 300
                guard error == nil, let statusCode = (response as? HTTPURLResponse)?.statusCode, successRange.contains(statusCode) else { return } // ì—ëŸ¬ ì—†ê³ , ë„¤íŠ¸ì›Œí‚¹ì— ì„±ê³µí–ˆëŠ”ì§€
                guard let resultData = data else { return }
                guard let info = UserInfoManager.parseInfo(resultData) else { return }
                UserInfoManager.user = info // ë°›ì•„ì˜¨ token ê°’ì„ ì €ì¥
                UserInfoManager.loginSuccessed() // ë¡œê·¸ì¸ ì„±ê³µ
            }
            
            dataTask.resume()
            
        }

    }
}

{% endhighlight %}
<br>

URLSessionì„ í†µí•´ ë°›ì•„ì˜¨ token ê°’ì„ ì €ì¥í•œ í›„ `loginSuccessed()` í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ì—¬ ë¡œê·¸ì¸ ì„±ê³µ í›„ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ë³€í™”ë¥¼ ì£¼ì—ˆë‹¤.

ì›ë˜ëŠ” token ê°’ì„ ì´ìš©í•´ ë‹¤ì‹œ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì™€ì•¼ í•˜ì§€ë§Œ URLSessionì„ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ ìì²´ëŠ” ê°™ìœ¼ë¯€ë¡œ ìš°ì„  ìƒëµí•˜ì˜€ë‹¤.
<br>
<br>
<br>

## 3. ì• í”Œë¦¬ì¼€ì´ì…˜ í™”ë©´ ë³€í™” ë³´ì—¬ì£¼ê¸°
---
ë¡œê·¸ì¸ì´ ë˜ì—ˆë‹¤ë©´ ì‚¬ìš©ìì—ê²Œ ì–´ë–¤ í¼í¬ë¨¼ìŠ¤ë¥¼ ë³´ì—¬ì¤˜ì•¼ í•œë‹¤. í™”ë©´ì´ ì´ë™ëœë‹¤ê±°ë‚˜, ì‚¬ìš©ì ì´ë¦„ì„ í™”ë©´ì— í‘œì‹œí•˜ì—¬ ë¡œê·¸ì¸ì´ ì„±ê³µì ìœ¼ë¡œ ëë‚¬ìŒì„ í‘œì‹œí•´ì£¼ì–´ì•¼í•˜ëŠ” ê²ƒì´ë‹¤. 

ì—¬ë‹´ìœ¼ë¡œ ì´ë²ˆ ë‹¨ê³„ê°€ ì´ í¬ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ê²Œ ëœ ê¶ê·¹ì ì¸ ì›ì¸ì´ë¼ í•  ìˆ˜ ìˆê² ë‹¤.

ì• í”Œë¦¬ì¼€ì´ì…˜ í™”ë©´ì— ë°°ì¹˜í•´ë‘ì—ˆë˜ ë ˆì´ë¸”ì— 'ë¡œê·¸ì¸ ì„±ê³µ'ì´ë¼ëŠ” ë¬¸ìì—´ì„ ë„ìš°ê¸° ìœ„í•´ tokenì´ ì €ì¥ëœ `UserInfoManager`ì™€ `ViewController`ë¥¼ ì—°ê²°í•˜ê³ , ë°ì´í„°ë¥¼ ì£¼ê³  ë°›ì„ í•„ìš”ê°€ ìˆì—ˆë‹¤.<br>
ë”°ë¼ì„œ, `LoginDelegate` protocolì„ ì‘ì„±í•˜ì—¬ ì—°ê²° ë§¤ê°œì²´ë¥¼ ë§Œë“¤ì—ˆë‹¤.

{% highlight Swift %}
protocol LoginDelegate {
    func loginSucceessed()
}
{% endhighlight %}
<br>

`UserInfoManager`ì— `LoginDelegate` íƒ€ì…ì˜ delegate ë³€ìˆ˜ë¥¼ ìƒì„±í•¨ìœ¼ë¡œì¨ `LoginDelegate` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í–ˆë‹¤.

{% highlight Swift %}
class UserInfoManager {
    static var delegate: LoginDelegate?
    // ìƒëµ

    static func loginSuccessed() {
        delegate?.loginSucceessed()
        print("Login Successed")
    }
}
{% endhighlight %}
<br>
<br>

í•œí¸ ViewControllerëŠ” LoginDelegateë¥¼ ìƒì†í•¨ìœ¼ë¡œì¨ ì‘ì„±í•´ì•¼í•˜ëŠ” `loginSuccessed()` í•¨ìˆ˜ë¥¼ í†µí•´ ì• í”Œë¦¬ì¼€ì´ì…˜ í™”ë©´ì˜ ë ˆì´ë¸”ì„ ë³€ê²½í•˜ì˜€ë‹¤. <br>
URLSession ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ê³  ìˆìœ¼ë¯€ë¡œ ë ˆì´ë¸”ì„ ë³€ê²½í•˜ëŠ” ì‘ì—…ì„ ë©”ì¸ ìŠ¤ë ˆë“œë¡œ ë³´ë‚´ì£¼ì–´ì•¼ í•œë‹¤.

{% highlight Swift %}
extension ViewController: LoginDelegate {
    func loginSucceessed() {
        DispatchQueue.main.async {
            self.userId.text = "Login Successed"
        }
    }
}

{% endhighlight %}
<br>
<br>

ì‹¤í–‰í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì˜ ì‘ë™í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤! ë§Œì„¸!ğŸ’ƒ

<div style="text-align: center;">
	<img src = "{{site.baseurl}}/images/20201110_4/success1.png" width="45%">
	<img src = "{{site.baseurl}}/images/20201110_4/success2.png" width="45%">
</div>


---
ì°¸ê³ : https://docs.github.com/en/enterprise-server@2.21/developers/apps/authorizing-oauth-apps

https://zeddios.tistory.com/1102

